---
# Prometheus role for monitoring VMs
# Installs and configures Prometheus for read-only monitoring
# Safe to run repeatedly (idempotent)

- name: Install Prometheus package
  ansible.builtin.apt:
    name: prometheus
    state: present
    update_cache: true
  when: ansible_os_family == "Debian"
  register: prometheus_installed

- name: Create Prometheus configuration directory
  ansible.builtin.file:
    path: /etc/prometheus
    state: directory
    owner: prometheus
    group: prometheus
    mode: '0755'

- name: Deploy Prometheus configuration from example
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../monitoring/prometheus/prometheus.yml.example"
    dest: /etc/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus
    mode: '0644'
    remote_src: false
  notify: Restart prometheus

- name: Ensure Prometheus service is enabled and running
  ansible.builtin.service:
    name: prometheus
    state: started
    enabled: true

- name: Verify Prometheus is listening on port 9090
  ansible.builtin.wait_for:
    port: 9090
    host: localhost
    delay: 2
    timeout: 10
  delegate_to: localhost
  when: prometheus_installed.changed

