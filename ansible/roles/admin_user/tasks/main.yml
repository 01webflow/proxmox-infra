---
# Manage a non-root administrative user with key-based SSH and passwordless sudo.
# Safe by default: only runs when admin_user_enabled is true.

- name: Ensure admin user exists
  ansible.builtin.user:
    name: "{{ admin_user_name }}"
    shell: /bin/bash
    create_home: true
    state: present
    groups: sudo
    append: true
  when: admin_user_enabled | bool

- name: Ensure .ssh directory for admin user
  ansible.builtin.file:
    path: "/home/{{ admin_user_name }}/.ssh"
    state: directory
    owner: "{{ admin_user_name }}"
    group: "{{ admin_user_name }}"
    mode: "0700"
  when: admin_user_enabled | bool

- name: Install admin authorized keys
  ansible.posix.authorized_key:
    user: "{{ admin_user_name }}"
    key: "{{ item }}"
    state: present
    manage_dir: false
    path: "/home/{{ admin_user_name }}/.ssh/authorized_keys"
  loop: "{{ admin_user_ssh_keys }}"
  when:
    - admin_user_enabled | bool
    - admin_user_ssh_keys | length > 0

- name: Configure passwordless sudo for admin user
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ admin_user_name }}"
    owner: root
    group: root
    mode: "0440"
    content: "{{ admin_user_name }} ALL=(ALL) NOPASSWD:ALL\n"
    validate: "visudo -cf %s"
  when: admin_user_enabled | bool

